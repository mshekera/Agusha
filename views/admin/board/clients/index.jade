extends ../layout

block append header
	link(href="/css/admin/datatables/dataTables.bootstrap.css" rel="stylesheet" type="text/css")
	link(href="/css/admin/daterangepicker/daterangepicker-bs3.css" rel="stylesheet" type="text/css")
	style.
		.popover-content span {
			font-weight: bold;
			font-size: 1.1em;
		}

		#export-form {
			width: 60%;
		}

		#export-form label {
			margin-left: 10px;
		}

block append scripts
	script(src="/js/admin/plugins/datatables/jquery.dataTables.js" type="text/javascript")
	script(src="/js/admin/plugins/datatables/dataTables.bootstrap.js" type="text/javascript")
	script(src="/js/admin/plugins/daterangepicker/daterangepicker.js")
	script(src="/js/plugins/moment/moment.js")
	script.
		$(function(){
			var momentFormat = 'DD/MM/YYYY HH:mm';
			$('.popovered').popover({
				delay: {
					show: 500,
					hide: 100
				},
				trigger: 'hover',
				html: true,
				container: 'body'
			});

			$('#client_list').dataTable({
				'iDisplayLength': 25,
				'aLengthMenu': [25,50,100]
			});

			$('#t-export-range').daterangepicker({
				timePicker: true, 
				timePickerIncrement: 5, 
				format: momentFormat,
				timePicker12Hour: true,
				startDate: moment().subtract('months', 1),
				endDate: moment(),
				maxDate: moment()
			});

			$('#t-export-range').val(moment().subtract('months', 1).format(momentFormat) + ' - ' + moment().format(momentFormat));

			$('.t-process').on('click', function(){
				var self = this,
					btn = $(self),
					opts = {
						id: btn.data('id')
					};

				btn.button('loading');
				$.post('clients/process', opts, function(response){
					if(typeof response === 'string' || !response.result) {
						alert(response || "Произошла неизвестная ошибка.");
						return btn.button('reset');
					} 

					if(response.result == 0) {
						alert('Клиент уже обработан!');
					}

					btn.parent().fadeOut().remove();
				});
			});

			$('.t-remove').on('click', function(){
				if(!confirm("Вы точно хотите удалить этого пользователя?")) {
					return;
				}

				var self = this,
					btn = $(self),
					opts = {
						id: btn.data('id')
					};

				btn.button('loading');
				$.post('clients/remove', opts, function(response){
					if(typeof response.result === 'string' || !response.result) {
						alert(response.result || "Произошла неизвестная ошибка.");
						return btn.button('reset');
					} 

					$('#client_list').DataTable()
						.row(btn.parents('tr'))
						.remove()
						.draw();
				});
			});

			$('.t-status').on('ifToggled', function(ev){
				var opts = {
						status: this.checked,
						id: $(this).data('id')
					},
					self = this;

				$.post('clients/setStatus', opts, function(response){
					if(response.result !== true) {
						var msg = response.result || "Произошла неизвестная ошибка.";
						msg += ' Состояние НЕ СОХРАНЕНО!'
						alert(msg);
					}
				});
			});

			/*$('#t-export').on('click', function(ev) {
				var form = $(this).closest('form');
				var data = form.serialize();

				$.post('clients/export', data);
			});*/
		});

block content
	.panel.panel-default
		.panel-heading
			| Экспорт данных в Excel (.xlsx формат)
		.panel-body
			form#export-form(role="form" enctype="multipart/form-data" method="post" action="/admin/clients/export")
				.form-group
					input(type="radio" name="type" value="created_at" checked)
					label(for="created_at")= " Выборка по дате регистрации"
				.form-group
					input(type="radio" name="type" value="activated_at")
					label(for="activated_at")= " Выборка по дате активации"
				.form-group
					label(for="range") Диапазон выборки:
					.input-group
						.input-group-addon
							i.fa.fa-clock-o
						input#t-export-range.form-control.pull-right(type="text" name="range")
				.form-group
					input#t-export.btn.btn-success(type="submit" value="Экспортировать")
	.panel.panel-default
		.panel-body
			table#client_list.table.table-striped.table-bordered.table-hover
				thead
					tr
						th ID
						th Логин
						th E-m@il
						th Дата регистрации:
						th Дата активации:
						th Тип:
						th Приглашение от:
						th Активен?
						th Подарок
						th Действия
				tbody
					- each u, key in clients
						- var content = "Имя: <span>" + u.fullName() + "</span><br/>Телефон: <span>" + u.phone + "</span><br/>Город: <span>" + (u.city?u.city.name:'-')  + "</span><br/>Улица: <span>" + u.street + "</span><br/>Номер дома: <span>" + u.house + "</span><br/>Квартира: <span>" + u.apartment + "</span><br/>Индекс: <span>" + u.postIndex + "</span><br/><br/>IP-адрес: <span>" + u.ip_address + "</span>";
						tr(data-id='#{u._id}')
							td #{u.id}
							td.popovered(
								data-toggle="popover" 
								title="Детальная информация"
								placement="right"
								data-content= content
							)
								span #{u.login}
							td #{u.email}
							td #{u.created_at}
							td #{u.activated_at}
							td #{u.type}
							td
								if u.invited_by
									| #{u.invited_by.login}
								else
									| -
							td= (u.active?"Да":"Нет")
							td
								input.t-status(type="checkbox" data-id=u._id checked=(u.status == true))
							td
								if u.newClient
									.dt-button
										button.btn.btn-primary.t-process(type="button" data-id=u._id data-loading-text="Ждите...")
											i.glyphicon.glyphicon-ok-circle
											span= " Обработать"
								.dt-button
									button.btn.btn-danger.t-remove(type="button" data-id=u._id data-loading-text="Ждите...")
										i.glyphicon.glyphicon-remove-circle
										span= " Удалить"